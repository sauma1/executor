local HttpService = game:GetService("HttpService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

local request = (syn and syn.request) or (http and http.request) or request

local searchHwidUrl = "http://api.thanhub.xyz/api/key/search-hwid"
local validateKeyUrl = "http://api.thanhub.xyz/api/key/validate"

local function searchHwid(apiKey, hwid)
    print("[DEBUG] Mencari HWID...")
    local success, response = pcall(function()
        return request({
            Url = searchHwidUrl,
            Method = "POST",
            Headers = {
                ["Content-Type"] = "application/json"
            },
            Body = HttpService:JSONEncode({
                apiKey = apiKey,
                hwid = hwid
            })
        })
    end)
    if not success then
        warn("Gagal menghubungi API (search HWID):", response)
        LocalPlayer:Kick("Tidak dapat terhubung ke server validasi.")
        return false
    end

    local status, data = pcall(function()
        return HttpService:JSONDecode(response.Body)
    end)
    if not status then
        warn("Gagal parsing response:", data)
        LocalPlayer:Kick("Kesalahan dalam memproses data validasi.")
        return false
    end

    if data.error then
        warn("API Key tidak valid atau HWID tidak ditemukan:", data.error)
        LocalPlayer:Kick("KEY Anda tidak valid.")
        return false
    end

    if data.hwid and data.hwid ~= hwid then
        warn("HWID berbeda! Terdaftar:", data.hwid, "| Saat ini:", hwid)
        LocalPlayer:Kick("HWID tidak cocok. Akses ditolak.")
        return false
    end

    print("[‚úÖ] HWID terdaftar:", data.hwid)
    return true
end

local function validateKey(apiKey, hwid)
    print("[DEBUG] Memvalidasi API Key...")
    local success, response = pcall(function()
        return request({
            Url = validateKeyUrl,
            Method = "POST",
            Headers = {
                ["Content-Type"] = "application/json"
            },
            Body = HttpService:JSONEncode({
                apiKey = apiKey,
                hwid = hwid
            })
        })
    end)
    if not success then
        warn("Gagal menghubungi API (validate Key):", response)
        return false
    end

    local status, body = pcall(function()
        return HttpService:JSONDecode(response.Body)
    end)
    if not status then
        warn("Gagal parsing response:", body)
        return false
    end

    if body.message == "API key valid dan HWID cocok" or body.message == "HWID ditambahkan, API key diaktifkan" then
        print("[‚úÖ] API Key valid dan HWID cocok.")
        return true
    else
        warn("[‚ùå] Validasi gagal:", body.error or "Tidak diketahui")
        return false
    end
end

local function runScript(apiKey)
    print("[DEBUG] Memulai runScript()...")
    local hwid = game:GetService("RbxAnalyticsService"):GetClientId()
    print("[DEBUG] HWID Anda:", hwid)

    if not searchHwid(apiKey, hwid) then
        print("[DEBUG] HWID tidak ditemukan, mencoba validasi API Key...")
        if not validateKey(apiKey, hwid) then
            warn("[‚ùå] Validasi gagal. Skrip dihentikan.")
            LocalPlayer:Kick("KEY tidak valid.")
            return false
        end
    end

    print("[üîí] Menjalankan skrip premium...")
    return true
end

function executeScript()
    print("[DEBUG] Mengeksekusi script...")
    if not script_key then
        warn("[‚ùå] script_key tidak ditemukan! Harap masukkan API key.")
        return
    end

    print("[DEBUG] API Key yang digunakan:", script_key)
    if runScript(script_key) then
        print("[DEBUG] Memuat Fluent UI...")
        local than = game:HttpGet("https://raw.githubusercontent.com/ThanHub-GG/TESTEERERERERER/refs/heads/main/WBUJUHWHWUEWEWE")
        local Fluent = loadstring(than)()

        local Window = Fluent:CreateWindow({
            Title = game:GetService("MarketplaceService"):GetProductInfo(16732694052).Name .. " | ThanHub v2.0",
            SubTitle = "discord.gg/thanhub || Premium",
            TabWidth = 160,
            Size = UDim2.fromOffset(470, 350),
            Acrylic = false,
            Theme = "Amethyst",
            MinimizeKey = Enum.KeyCode.LeftControl
        })

        print("[‚úÖ] Fluent UI berhasil dimuat.")
    end
end

executeScript()
